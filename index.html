import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, runTransaction } from 'firebase/firestore';

// قم بتعريف متغيرات Firebase العامة (مقدمة من البيئة).
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// قائمة بالأسئلة والإجابات
const questions = [
  {
    question: "ما هو أكبر كوكب في المجموعة الشمسية؟",
    options: ["المريخ", "المشتري", "زحل"],
    answer: "المشتري"
  },
  {
    question: "من هو مؤلف رواية 'مئة عام من العزلة'؟",
    options: ["خورخي لويس بورخيس", "باولو كويلو", "غابرييل غارسيا ماركيز"],
    answer: "غابرييل غارسيا ماركيز"
  },
  {
    question: "ما هي عاصمة أستراليا؟",
    options: ["سيدني", "ملبورن", "كانبرا"],
    answer: "كانبرا"
  },
  {
    question: "ما هو العنصر الكيميائي الذي يرمز له بالرمز 'Au'؟",
    options: ["الفضة", "الذهب", "النحاس"],
    answer: "الذهب"
  },
  {
    question: "كم عدد ألوان قوس قزح؟",
    options: ["6", "7", "8"],
    answer: "7"
  }
];

// دالة لجلب سؤال عشوائي
const getRandomQuestion = () => {
  const randomIndex = Math.floor(Math.random() * questions.length);
  return questions[randomIndex];
};

const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [gameId, setGameId] = useState('');
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [isGameReady, setIsGameReady] = useState(false);
  const [playerMarker, setPlayerMarker] = useState(null);
  const [board, setBoard] = useState(Array(9).fill(null));
  const [turn, setTurn] = useState('X');
  const [question, setQuestion] = useState(null);
  const [selectedCell, setSelectedCell] = useState(null);
  const [message, setMessage] = useState('');

  // تهيئة Firebase والتحقق من حالة المصادقة
  useEffect(() => {
    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const authService = getAuth(app);
      setDb(firestore);
      setAuth(authService);

      // الاستماع لتغييرات حالة المصادقة باستخدام onAuthStateChanged
      if (authService) {
        onAuthStateChanged(authService, (user) => {
          if (user) {
            setUserId(user.uid);
            setIsAuthReady(true);
          } else {
            // في حالة عدم وجود مستخدم، قم بتسجيل الدخول
            if (initialAuthToken) {
              signInWithCustomToken(authService, initialAuthToken).catch(err => {
                console.error("خطأ في تسجيل الدخول الرمزي:", err);
                signInAnonymously(authService).then(() => {
                    setMessage("تم تسجيل الدخول كمستخدم مجهول. يمكنك الآن اللعب.");
                });
              });
            } else {
              signInAnonymously(authService).then(() => {
                  setMessage("تم تسجيل الدخول كمستخدم مجهول. يمكنك الآن اللعب.");
              });
            }
          }
        });
      }
    } catch (error) {
      console.error("خطأ في تهيئة Firebase:", error);
      setMessage("حدث خطأ في تهيئة اللعبة. يرجى المحاولة مرة أخرى.");
    }
  }, []);

  // الاستماع لتغييرات اللعبة في Firestore
  useEffect(() => {
    if (!db || !isAuthReady || !gameId) return;

    const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);

    const unsubscribe = onSnapshot(gameDocRef, (docSnap) => {
      if (docSnap.exists()) {
        const gameData = docSnap.data();
        if (gameData.board) {
          setBoard(gameData.board);
        }
        if (gameData.turn) {
          setTurn(gameData.turn);
        }
        if (gameData.players) {
          // تحديد الرمز الخاص باللاعب الحالي ('X' أو 'O')
          const playerIds = Object.keys(gameData.players);
          if (playerIds.includes(userId)) {
            const marker = playerIds[0] === userId ? 'X' : 'O';
            setPlayerMarker(marker);
            setIsGameReady(true);
            setMessage(`أنت اللاعب ${marker}. دور ${gameData.turn}.`);
          } else if (playerIds.length < 2) {
            setMessage('انتظر لاعبًا آخر للانضمام...');
          } else {
             setMessage('هذه الغرفة ممتلئة.');
          }
        }
        
        // التحقق من الفائز أو التعادل
        const winner = checkWinner(gameData.board);
        if (winner) {
            setMessage(`اللاعب ${winner} هو الفائز!`);
        } else if (gameData.board.every(cell => cell !== null)) {
            setMessage("تعادل!");
        }

      } else {
        setMessage('لم يتم العثور على اللعبة بهذا الرمز. قم بإنشاء واحدة أو تأكد من الرمز.');
        setIsGameReady(false);
        setPlayerMarker(null);
      }
    });

    return () => unsubscribe();
  }, [db, isAuthReady, gameId, userId]);

  // دالة لإنشاء لعبة جديدة
  const createNewGame = async () => {
    if (!db || !userId) {
      setMessage("لا يمكن إنشاء اللعبة. يرجى التأكد من الاتصال.");
      return;
    }
    const newGameId = crypto.randomUUID().slice(0, 6);
    const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${newGameId}`);
    const initialBoard = Array(9).fill(null);
    const players = { [userId]: 'X' }; // اللاعب الأول هو 'X'
    try {
      await setDoc(gameDocRef, {
        board: initialBoard,
        turn: 'X',
        players: players
      });
      setGameId(newGameId);
      setPlayerMarker('X');
      setIsGameReady(true);
      setMessage(`تم إنشاء اللعبة! شارك هذا الرمز: ${newGameId}`);
    } catch (e) {
      console.error("خطأ في إنشاء اللعبة:", e);
      setMessage("فشل إنشاء اللعبة. حاول مرة أخرى.");
    }
  };

  // دالة للانضمام إلى لعبة موجودة
  const joinGame = async (e) => {
    e.preventDefault();
    if (!db || !userId || !gameId) {
      setMessage("الرمز غير صحيح أو المستخدم غير متصل.");
      return;
    }
    const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);

    try {
      await runTransaction(db, async (transaction) => {
        const gameDoc = await transaction.get(gameDocRef);
        if (!gameDoc.exists()) {
          throw "لم يتم العثور على اللعبة.";
        }
        const gameData = gameDoc.data();
        const playerIds = Object.keys(gameData.players);

        if (playerIds.length >= 2) {
          throw "هذه اللعبة ممتلئة.";
        }

        if (playerIds.includes(userId)) {
          // إذا كان اللاعب قد انضم بالفعل، لا تفعل شيئًا
          return;
        }

        const newPlayers = { ...gameData.players, [userId]: 'O' };
        setPlayerMarker('O');
        setIsGameReady(true);
        transaction.update(gameDocRef, { players: newPlayers });
        setMessage(`انضممت إلى اللعبة! أنت اللاعب O.`);
      });
    } catch (e) {
      console.error("خطأ في الانضمام إلى اللعبة:", e);
      setMessage(`فشل الانضمام: ${e}`);
    }
  };

  // دالة للتعامل مع النقر على خلية
  const handleCellClick = (index) => {
    if (!isGameReady || board[index] || turn !== playerMarker || checkWinner(board) || board.every(c => c !== null)) {
      return;
    }
    setSelectedCell(index);
    setQuestion(getRandomQuestion());
    setMessage(`دورك! أجب على السؤال لوضع علامة ${playerMarker}.`);
  };

  // دالة للتحقق من الإجابة
  const handleAnswer = async (selectedOption) => {
    if (!question || selectedCell === null) return;
    
    if (selectedOption === question.answer) {
      setMessage("إجابة صحيحة! قم بوضع علامتك.");
      await updateBoard(selectedCell, playerMarker);
    } else {
      setMessage("إجابة خاطئة. فقدت دورك.");
      await updateBoard(selectedCell, null);
    }
    setQuestion(null);
    setSelectedCell(null);
  };

  // دالة لتحديث اللوحة وإخبار اللاعب الآخر
  const updateBoard = async (index, marker) => {
    if (!db || !gameId || selectedCell === null) return;
    const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);

    await runTransaction(db, async (transaction) => {
      const gameDoc = await transaction.get(gameDocRef);
      if (!gameDoc.exists()) return;
      
      const gameData = gameDoc.data();
      const newBoard = [...gameData.board];
      if (marker) {
          newBoard[index] = marker;
      }
      
      const nextTurn = turn === 'X' ? 'O' : 'X';
      transaction.update(gameDocRef, {
        board: newBoard,
        turn: nextTurn
      });
    });
  };

  // دالة للتحقق من الفائز
  const checkWinner = (currentBoard) => {
    const lines = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8],
      [0, 3, 6], [1, 4, 7], [2, 5, 8],
      [0, 4, 8], [2, 4, 6]
    ];
    for (let i = 0; i < lines.length; i++) {
      const [a, b, c] = lines[i];
      if (currentBoard[a] && currentBoard[a] === currentBoard[b] && currentBoard[a] === currentBoard[c]) {
        return currentBoard[a];
      }
    }
    return null;
  };

  const resetGame = async () => {
    if (!db || !gameId) return;
    const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);
    try {
      await setDoc(gameDocRef, {
        board: Array(9).fill(null),
        turn: 'X',
        players: { [userId]: playerMarker } // الاحتفاظ باللاعب الحالي فقط
      });
      setMessage("تم إعادة اللعبة.");
    } catch (e) {
      console.error("خطأ في إعادة ضبط اللعبة:", e);
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
      <div className="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-xl text-center">
        <h1 className="text-4xl font-extrabold text-blue-600 mb-4">لعبة XO المعرفية</h1>
        
        {!isGameReady ? (
          <div className="flex flex-col items-center space-y-4">
            <h2 className="text-2xl font-bold text-gray-700">العب عبر الإنترنت</h2>
            <button
              onClick={createNewGame}
              className="px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600 transition-colors"
            >
              إنشاء لعبة جديدة
            </button>
            <div className="flex items-center space-x-2">
                <span className="text-gray-500">أو</span>
            </div>
            <form onSubmit={joinGame} className="flex flex-col space-y-2 w-full">
              <input
                type="text"
                value={gameId}
                onChange={(e) => setGameId(e.target.value)}
                placeholder="أدخل رمز اللعبة"
                className="p-3 border rounded-lg text-center font-mono"
              />
              <button
                type="submit"
                className="px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-lg hover:bg-blue-600 transition-colors"
              >
                الانضمام إلى لعبة
              </button>
            </form>
          </div>
        ) : (
          <div className="space-y-6">
            <p className="text-xl font-semibold text-gray-800">{message}</p>
            <p className="text-sm text-gray-500">رمز اللعبة: <span className="font-bold text-blue-600">{gameId}</span></p>
            <p className="text-sm text-gray-500">معرف المستخدم: <span className="font-bold text-blue-600">{userId}</span></p>

            <div className="grid grid-cols-3 gap-2">
              {board.map((cell, index) => (
                <button
                  key={index}
                  className={`
                    w-28 h-28 sm:w-32 sm:h-32 text-5xl font-extrabold rounded-lg shadow-inner transition-colors duration-200
                    ${cell ? 'cursor-not-allowed' : (turn === playerMarker ? 'bg-gray-200 hover:bg-gray-300' : 'bg-gray-100 cursor-not-allowed')}
                    ${cell === 'X' ? 'text-red-500' : (cell === 'O' ? 'text-blue-500' : 'text-gray-400')}
                  `}
                  onClick={() => handleCellClick(index)}
                  disabled={cell || turn !== playerMarker}
                >
                  {cell}
                </button>
              ))}
            </div>
            
            {question && (
              <div className="bg-blue-50 rounded-xl p-4 shadow-inner">
                <h3 className="text-xl font-bold mb-3">{question.question}</h3>
                <div className="flex flex-col space-y-2">
                  {question.options.map((option, index) => (
                    <button
                      key={index}
                      className="px-4 py-2 bg-blue-400 text-white font-bold rounded-full hover:bg-blue-500 transition-colors"
                      onClick={() => handleAnswer(option)}
                    >
                      {option}
                    </button>
                  ))}
                </div>
              </div>
            )}
            <button
              onClick={resetGame}
              className="mt-4 px-6 py-3 bg-red-500 text-white font-bold rounded-full shadow-lg hover:bg-red-600 transition-colors"
            >
              إعادة اللعبة
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default App;
