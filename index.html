<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة XO المعرفية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            direction: rtl;
            font-family: 'Inter', sans-serif;
        }
        .rotated-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div id="app" class="flex flex-col items-center justify-center min-h-screen">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-xl text-center">
            <h1 class="text-4xl font-extrabold text-blue-600 mb-4">لعبة XO المعرفية</h1>
            
            <div id="game-container" class="space-y-6">
                <!-- هذا الجزء سيتم تعديله بواسطة JavaScript -->
                <p id="message" class="text-xl font-semibold text-gray-800"></p>
                
                <div id="initial-screen" class="flex flex-col items-center space-y-4">
                    <h2 class="text-2xl font-bold text-gray-700">العب عبر الإنترنت</h2>
                    <button id="create-game-btn" class="px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600 transition-colors">
                        إنشاء لعبة جديدة
                    </button>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-500">أو</span>
                    </div>
                    <form id="join-game-form" class="flex flex-col space-y-2 w-full">
                        <input
                            type="text"
                            id="game-id-input"
                            placeholder="أدخل رمز اللعبة"
                            class="p-3 border rounded-lg text-center font-mono"
                        />
                        <button
                            type="submit"
                            class="px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-lg hover:bg-blue-600 transition-colors"
                        >
                            الانضمام إلى لعبة
                        </button>
                    </form>
                </div>

                <div id="game-board-container" class="hidden">
                    <p class="text-sm text-gray-500">رمز اللعبة: <span id="display-game-id" class="font-bold text-blue-600"></span></p>
                    <p class="text-sm text-gray-500">معرف المستخدم: <span id="display-user-id" class="font-bold text-blue-600"></span></p>
                    
                    <div id="board" class="grid grid-cols-3 gap-2">
                        <!-- الخلايا سيتم إنشاؤها بواسطة JavaScript -->
                    </div>
                    
                    <div id="question-box" class="hidden bg-blue-50 rounded-xl p-4 shadow-inner mt-4">
                        <h3 id="question-text" class="text-xl font-bold mb-3"></h3>
                        <div id="options-container" class="flex flex-col space-y-2">
                            <!-- الأزرار سيتم إنشاؤها بواسطة JavaScript -->
                        </div>
                    </div>
                    
                    <button id="reset-game-btn" class="mt-4 px-6 py-3 bg-red-500 text-white font-bold rounded-full shadow-lg hover:bg-red-600 transition-colors">
                        إعادة اللعبة
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // قم بتعريف متغيرات Firebase العامة (مقدمة من البيئة).
        // هذه المعلومات يجب أن تكون خاصة بمشروعك في Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCvWZsTZrMioV2ODpN0KqYimcFhHXmSiIE",
            authDomain: "speakright-skjwg.firebaseapp.com",
            databaseURL: "https://speakright-skjwg-default-rtdb.firebaseio.com",
            projectId: "speakright-skjwg",
            storageBucket: "speakright-skjwg.firebasestorage.app",
            messagingSenderId: "81615484560",
            appId: "1:81615484560:web:7f7d1922b2917c541aca15"
        };
        const appId = firebaseConfig.appId;
        const initialAuthToken = null; // لم يعد هذا مطلوبًا
        
        // واجهات المستخدم
        const messageEl = document.getElementById('message');
        const initialScreenEl = document.getElementById('initial-screen');
        const gameBoardContainerEl = document.getElementById('game-board-container');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameForm = document.getElementById('join-game-form');
        const gameIdInput = document.getElementById('game-id-input');
        const displayGameIdEl = document.getElementById('display-game-id');
        const displayUserIdEl = document.getElementById('display-user-id');
        const boardEl = document.getElementById('board');
        const questionBoxEl = document.getElementById('question-box');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainerEl = document.getElementById('options-container');
        const resetGameBtn = document.getElementById('reset-game-btn');

        let db, auth, userId = null;
        let gameId = '';
        let isAuthReady = false;
        let isGameReady = false;
        let playerMarker = null;
        let board = Array(9).fill(null);
        let turn = 'X';
        let question = null;
        let selectedCell = null;

        // قائمة الأسئلة (يمكن نقلها إلى قاعدة البيانات لاحقًا)
        const questions = [
            { question: "ما هو أكبر كوكب في المجموعة الشمسية؟", options: ["المريخ", "المشتري", "زحل"], answer: "المشتري" },
            { question: "من هو مؤلف رواية 'مئة عام من العزلة'؟", options: ["خورخي لويس بورخيس", "باولو كويلو", "غابرييل غارسيا ماركيز"], answer: "غابرييل غارسيا ماركيز" },
            { question: "ما هي عاصمة أستراليا؟", options: ["سيدني", "ملبورن", "كانبرا"], answer: "كانبرا" },
            { question: "ما هو العنصر الكيميائي الذي يرمز له بالرمز 'Au'؟", options: ["الفضة", "الذهب", "النحاس"], answer: "الذهب" },
            { question: "كم عدد ألوان قوس قزح؟", options: ["6", "7", "8"], answer: "7" }
        ];

        const getRandomQuestion = () => {
            const randomIndex = Math.floor(Math.random() * questions.length);
            return questions[randomIndex];
        };

        const updateUI = () => {
            if (isGameReady) {
                initialScreenEl.classList.add('hidden');
                gameBoardContainerEl.classList.remove('hidden');
            } else {
                initialScreenEl.classList.remove('hidden');
                gameBoardContainerEl.classList.add('hidden');
            }
        };

        const setBoard = (newBoard) => {
            board = newBoard;
            boardEl.innerHTML = '';
            board.forEach((cell, index) => {
                const cellBtn = document.createElement('button');
                cellBtn.className = `w-28 h-28 sm:w-32 sm:h-32 text-5xl font-extrabold rounded-lg shadow-inner transition-colors duration-200 ${
                    cell ? 'cursor-not-allowed' : (turn === playerMarker ? 'bg-gray-200 hover:bg-gray-300' : 'bg-gray-100 cursor-not-allowed')
                } ${
                    cell === 'X' ? 'text-red-500' : (cell === 'O' ? 'text-blue-500' : 'text-gray-400')
                }`;
                cellBtn.innerText = cell || '';
                cellBtn.onclick = () => handleCellClick(index);
                boardEl.appendChild(cellBtn);
            });
        };

        const checkWinner = (currentBoard) => {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (let i = 0; i < lines.length; i++) {
                const [a, b, c] = lines[i];
                if (currentBoard[a] && currentBoard[a] === currentBoard[b] && currentBoard[a] === currentBoard[c]) {
                    return currentBoard[a];
                }
            }
            return null;
        };

        const updateBoard = async (index, marker) => {
            if (!db || !gameId || selectedCell === null) return;
            const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameDocRef);
                    if (!gameDoc.exists()) return;
                    
                    const gameData = gameDoc.data();
                    const newBoard = [...gameData.board];
                    if (marker) {
                        newBoard[index] = marker;
                    }
                    
                    const nextTurn = gameData.turn === 'X' ? 'O' : 'X';
                    transaction.update(gameDocRef, {
                        board: newBoard,
                        turn: nextTurn
                    });
                });
            } catch (e) {
                console.error("خطأ في تحديث اللوحة:", e);
                messageEl.innerText = `فشل تحديث اللوحة: ${e.message}`;
            }
        };

        const handleCellClick = (index) => {
            if (!isGameReady || board[index] || turn !== playerMarker || checkWinner(board) || board.every(c => c !== null)) {
                return;
            }
            selectedCell = index;
            question = getRandomQuestion();
            messageEl.innerText = `دورك! أجب على السؤال لوضع علامة ${playerMarker}.`;
            
            questionBoxEl.classList.remove('hidden');
            questionTextEl.innerText = question.question;
            optionsContainerEl.innerHTML = '';
            question.options.forEach((option) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = "px-4 py-2 bg-blue-400 text-white font-bold rounded-full hover:bg-blue-500 transition-colors";
                optionBtn.innerText = option;
                optionBtn.onclick = () => handleAnswer(option);
                optionsContainerEl.appendChild(optionBtn);
            });
        };

        const handleAnswer = async (selectedOption) => {
            if (!question || selectedCell === null) return;
            questionBoxEl.classList.add('hidden');

            if (selectedOption === question.answer) {
                messageEl.innerText = "إجابة صحيحة! قم بوضع علامتك.";
                await updateBoard(selectedCell, playerMarker);
            } else {
                messageEl.innerText = "إجابة خاطئة. فقدت دورك.";
                await updateBoard(selectedCell, null);
            }
            question = null;
            selectedCell = null;
        };

        const createNewGame = async () => {
            if (!db || !userId) {
                messageEl.innerText = "لا يمكن إنشاء اللعبة. يرجى التأكد من الاتصال.";
                return;
            }
            const newGameId = crypto.randomUUID().slice(0, 6);
            const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${newGameId}`);
            const initialBoard = Array(9).fill(null);
            const players = { [userId]: 'X' };
            try {
                await setDoc(gameDocRef, {
                    board: initialBoard,
                    turn: 'X',
                    players: players
                });
                gameId = newGameId;
                playerMarker = 'X';
                isGameReady = true;
                messageEl.innerText = `تم إنشاء اللعبة! شارك هذا الرمز: ${newGameId}`;
                displayGameIdEl.innerText = newGameId;
                updateUI();
            } catch (e) {
                console.error("خطأ في إنشاء اللعبة:", e);
                messageEl.innerText = "فشل إنشاء اللعبة. حاول مرة أخرى.";
            }
        };

        const joinGame = async (e) => {
            e.preventDefault();
            const inputGameId = gameIdInput.value.trim();
            if (!db || !userId || !inputGameId) {
                messageEl.innerText = "الرمز غير صحيح أو المستخدم غير متصل.";
                return;
            }
            gameId = inputGameId;
            const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);

            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameDocRef);
                    if (!gameDoc.exists()) {
                        throw new Error("لم يتم العثور على اللعبة.");
                    }
                    const gameData = gameDoc.data();
                    const playerIds = Object.keys(gameData.players);

                    if (playerIds.length >= 2) {
                        throw new Error("هذه اللعبة ممتلئة.");
                    }

                    if (playerIds.includes(userId)) {
                        // Player is already in the game, no need to add again
                        isGameReady = true;
                        playerMarker = playerIds[0] === userId ? 'X' : 'O';
                        messageEl.innerText = `أنت بالفعل في اللعبة! أنت اللاعب ${playerMarker}.`;
                        displayGameIdEl.innerText = gameId;
                        updateUI();
                        return;
                    }

                    const newPlayers = { ...gameData.players, [userId]: 'O' };
                    playerMarker = 'O';
                    isGameReady = true;
                    transaction.update(gameDocRef, { players: newPlayers });
                    messageEl.innerText = `انضممت إلى اللعبة! أنت اللاعب O.`;
                    displayGameIdEl.innerText = gameId;
                    updateUI();
                });
            } catch (e) {
                console.error("خطأ في الانضمام إلى اللعبة:", e);
                messageEl.innerText = `فشل الانضمام: ${e.message}`;
            }
        };
        
        const resetGame = async () => {
            if (!db || !gameId) return;
            const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);
            try {
                await setDoc(gameDocRef, {
                    board: Array(9).fill(null),
                    turn: 'X',
                    players: { [userId]: playerMarker } // الاحتفاظ باللاعب الحالي فقط
                });
                messageEl.innerText = "تم إعادة اللعبة.";
            } catch (e) {
                console.error("خطأ في إعادة ضبط اللعبة:", e);
            }
        };

        // تهيئة Firebase عند تحميل الصفحة
        window.onload = () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        displayUserIdEl.innerText = userId;
                    } else {
                         signInAnonymously(auth).catch(err => {
                                console.error("خطأ في تسجيل الدخول المجهول:", err);
                                messageEl.innerText = "فشل تسجيل الدخول. يرجى المحاولة مرة أخرى.";
                            });
                    }
                });

                // الاستماع لتغييرات اللعبة في Firestore
                const listenForGameChanges = () => {
                    if (!db || !isAuthReady || !gameId) {
                        setTimeout(listenForGameChanges, 500);
                        return;
                    }

                    const gameDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);
                    onSnapshot(gameDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const gameData = docSnap.data();
                            if (gameData.board) {
                                setBoard(gameData.board);
                            }
                            if (gameData.turn) {
                                turn = gameData.turn;
                            }
                            if (gameData.players) {
                                const playerIds = Object.keys(gameData.players);
                                if (playerIds.includes(userId)) {
                                    playerMarker = playerIds[0] === userId ? 'X' : 'O';
                                    isGameReady = true;
                                    messageEl.innerText = `أنت اللاعب ${playerMarker}. دور ${gameData.turn}.`;
                                    updateUI();
                                } else if (playerIds.length < 2) {
                                    messageEl.innerText = 'انتظر لاعبًا آخر للانضمام...';
                                } else {
                                    messageEl.innerText = 'هذه الغرفة ممتلئة.';
                                }
                            }
                            
                            const winner = checkWinner(gameData.board);
                            if (winner) {
                                messageEl.innerText = `اللاعب ${winner} هو الفائز!`;
                            } else if (gameData.board.every(cell => cell !== null)) {
                                messageEl.innerText = "تعادل!";
                            }
                        } else {
                            messageEl.innerText = 'لم يتم العثور على اللعبة بهذا الرمز. قم بإنشاء واحدة أو تأكد من الرمز.';
                            isGameReady = false;
                            playerMarker = null;
                            updateUI();
                        }
                    });
                };

                // ربط الأحداث
                createGameBtn.onclick = createNewGame;
                joinGameForm.onsubmit = joinGame;
                resetGameBtn.onclick = resetGame;

                listenForGameChanges();

            } catch (error) {
                console.error("خطأ في تهيئة Firebase:", error);
                messageEl.innerText = "حدث خطأ في تهيئة اللعبة. يرجى المحاولة مرة أخرى.";
            }
        };

    </script>
</body>
</html>
